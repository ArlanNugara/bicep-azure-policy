targetScope = 'subscription'

param client string
output policyId string = pv5_a_vulnerability_assessment_solution_should_be_enabled_on_your_virtual_machines_policy.id
resource pv5_a_vulnerability_assessment_solution_should_be_enabled_on_your_virtual_machines_policy 'Microsoft.Authorization/policyDefinitions@2021-06-01' = {
  name: '${client}-A vulnerability assessment solution should be enabled on your virtual machines'
  properties: {
    displayName: '${client}-A vulnerability assessment solution should be enabled on your virtual machines'
    policyType: 'Custom'
    mode: 'All'
    description: 'Audits virtual machines to detect whether they are running a supported vulnerability assessment solution. A core component of every cyber risk and security program is the identification and analysis of vulnerabilities. Azure Security Center\'s standard pricing tier includes vulnerability scanning for your virtual machines at no extra cost. Additionally, Security Center can automatically deploy this tool for you.'
    metadata: {
      version: '3.0.0'
      category: 'Security Center'
    }
    policyRule: {
      if: {
        field: 'type'
        in: [
          'Microsoft.Compute/virtualMachines'
          'Microsoft.ClassicCompute/virtualMachines'
        ]
      }
      then: {
        effect: 'AuditIfNotExists'
        details: {
          type: 'Microsoft.Security/assessments'
          name: 'ffff0522-1e88-47fc-8382-2a80ba848f5d'
          existenceCondition: {
            field: 'Microsoft.Security/assessments/status.code'
            in: [
              'NotApplicable'
              'Healthy'
            ]
          }
        }
      }
    }
  }
}
