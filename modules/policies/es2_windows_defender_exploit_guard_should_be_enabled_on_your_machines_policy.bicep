targetScope = 'subscription'

param client string
output policyId string = es2_windows_defender_exploit_guard_should_be_enabled_on_your_machines_policy.id
resource es2_windows_defender_exploit_guard_should_be_enabled_on_your_machines_policy 'Microsoft.Authorization/policyDefinitions@2021-06-01' = {
  name: '${client}-Windows Defender Exploit Guard should be enabled on your machines'
  properties: {
    displayName: '${client}-Windows Defender Exploit Guard should be enabled on your machines'
    policyType: 'Custom'
    mode: 'Indexed'
    description: 'Windows Defender Exploit Guard uses the Azure Policy Guest Configuration agent. Exploit Guard has four components that are designed to lock down devices against a wide variety of attack vectors and block behaviors commonly used in malware attacks while enabling enterprises to balance their security risk and productivity requirements (Windows only).'
    metadata: {
      category: 'Guest Configuration'
      version: '2.0.0'
      requiredProviders: [
        'Microsoft.GuestConfiguration'
      ]
      guestConfiguration: {
        name: 'WindowsDefenderExploitGuard'
        version: '1.*'
        configurationParameter: {
          NotAvailableMachineState: '[WindowsDefenderExploitGuard]WindowsDefenderExploitGuard1;NotAvailableMachineState'
        }
      }
    }
    parameters: {
      IncludeArcMachines: {
        type: 'String'
        metadata: {
          displayName: 'Include Arc connected servers'
          description: 'By selecting this option, you agree to be charged monthly per Arc connected machine.'
          portalReview: 'true'
        }
        allowedValues: [
          'true'
          'false'
        ]
        defaultValue: 'false'
      }
      NotAvailableMachineState: {
        type: 'String'
        metadata: {
          displayName: 'Status if Windows Defender is not available on machine'
          description: 'Windows Defender Exploit Guard is only available starting with Windows 10/Windows Server with update 1709. Setting this value to \'Non-Compliant\' shows machines with older versions on which Windows Defender Exploit Guard is not available (such as Windows Server 2012 R2) as non-compliant. Setting this value to \'Compliant\' shows these machines as compliant.'
        }
        allowedValues: [
          'Compliant'
          'Non-Compliant'
        ]
        defaultValue: 'Compliant'
      }
    }
    policyRule: {
      if: {
        anyOf: [
          {
            allOf: [
              {
                field: 'type'
                equals: 'Microsoft.Compute/virtualMachines'
              }
              {
                anyOf: [
                  {
                    field: 'Microsoft.Compute/imagePublisher'
                    in: [
                      'esri'
                      'incredibuild'
                      'MicrosoftDynamicsAX'
                      'MicrosoftSharepoint'
                      'MicrosoftVisualStudio'
                      'MicrosoftWindowsDesktop'
                      'MicrosoftWindowsServerHPCPack'
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'MicrosoftWindowsServer'
                      }
                      {
                        field: 'Microsoft.Compute/imageSKU'
                        notLike: '2008*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'MicrosoftSQLServer'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        notLike: 'SQL2008*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'microsoft-dsvm'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        like: 'dsvm-win*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'microsoft-ads'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        in: [
                          'standard-data-science-vm'
                          'windows-data-science-vm'
                        ]
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'batch'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        equals: 'rendering-windows2016'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'center-for-internet-security-inc'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        like: 'cis-windows-server-201*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'pivotal'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        like: 'bosh-windows-server*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'Microsoft.Compute/imagePublisher'
                        equals: 'cloud-infrastructure-services'
                      }
                      {
                        field: 'Microsoft.Compute/imageOffer'
                        like: 'ad*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        anyOf: [
                          {
                            field: 'Microsoft.Compute/virtualMachines/osProfile.windowsConfiguration'
                            exists: 'true'
                          }
                          {
                            field: 'Microsoft.Compute/virtualMachines/storageProfile.osDisk.osType'
                            like: 'Windows*'
                          }
                        ]
                      }
                      {
                        anyOf: [
                          {
                            field: 'Microsoft.Compute/imageSKU'
                            exists: 'false'
                          }
                          {
                            allOf: [
                              {
                                field: 'Microsoft.Compute/imageSKU'
                                notLike: '2008*'
                              }
                              {
                                field: 'Microsoft.Compute/imageOffer'
                                notLike: 'SQL2008*'
                              }
                            ]
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            ]
          }
          {
            allOf: [
              {
                value: '[parameters(\'IncludeArcMachines\')]'
                equals: 'true'
              }
              {
                anyOf: [
                  {
                    allOf: [
                      {
                        field: 'type'
                        equals: 'Microsoft.HybridCompute/machines'
                      }
                      {
                        field: 'Microsoft.HybridCompute/imageOffer'
                        like: 'windows*'
                      }
                    ]
                  }
                  {
                    allOf: [
                      {
                        field: 'type'
                        equals: 'Microsoft.ConnectedVMwarevSphere/virtualMachines'
                      }
                      {
                        field: 'Microsoft.ConnectedVMwarevSphere/virtualMachines/osProfile.osType'
                        like: 'windows*'
                      }
                    ]
                  }
                ]
              }
            ]
          }
        ]
      }
      then: {
        effect: 'AuditIfNotExists'
        details: {
          type: 'Microsoft.GuestConfiguration/guestConfigurationAssignments'
          name: 'WindowsDefenderExploitGuard'
          existenceCondition: {
            allOf: [
              {
                field: 'Microsoft.GuestConfiguration/guestConfigurationAssignments/complianceStatus'
                equals: 'Compliant'
              }
              {
                field: 'Microsoft.GuestConfiguration/guestConfigurationAssignments/parameterHash'
                equals: '[base64(concat(\'[WindowsDefenderExploitGuard]WindowsDefenderExploitGuard1;NotAvailableMachineState\', \'=\', parameters(\'NotAvailableMachineState\')))]'
              }
            ]
          }
        }
      }
    }
  }
}
