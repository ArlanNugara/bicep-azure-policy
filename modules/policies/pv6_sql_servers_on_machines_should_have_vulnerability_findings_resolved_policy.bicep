targetScope = 'subscription'

param client string
output policyId string = pv6_sql_servers_on_machines_should_have_vulnerability_findings_resolved_policy.id
resource pv6_sql_servers_on_machines_should_have_vulnerability_findings_resolved_policy 'Microsoft.Authorization/policyDefinitions@2021-06-01' = {
  name: '${client}-SQL servers on machines should have vulnerability findings resolved'
  properties: {
    displayName: '${client}-SQL servers on machines should have vulnerability findings resolved'
    policyType: 'Custom'
    mode: 'Indexed'
    description: 'SQL vulnerability assessment scans your database for security vulnerabilities, and exposes any deviations from best practices such as misconfigurations, excessive permissions, and unprotected sensitive data. Resolving the vulnerabilities found can greatly improve your database security posture.'
    metadata: {
      version: '1.0.0'
      category: 'Security Center'
    }
    policyRule: {
      if: {
        field: 'type'
        in: [
          'Microsoft.Compute/virtualMachines'
          'Microsoft.HybridCompute/machines'
        ]
      }
      then: {
        effect: 'AuditIfNotExists'
        details: {
          type: 'Microsoft.Security/assessments'
          name: 'f97aa83c-9b63-4f9a-99f6-b22c4398f936'
          existenceCondition: {
            field: 'Microsoft.Security/assessments/status.code'
            in: [
              'NotApplicable'
              'Healthy'
            ]
          }
        }
      }
    }
  }
}
